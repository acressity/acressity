{% extends "experiences/base.html" %}

{% load comments %}

{% block content %}
	<h2>{{ experience }}</h2>
	<div class="featured_photo">
		{% if experience.gallery.featured_photo %}
			<a href="{% url 'pl-gallery' experience.gallery.id %}">
				<img src="{{ experience.gallery.featured_photo.get_display_url }}" />
			</a>
			{% if experience.gallery.featured_photo.caption %}
				<div class="caption">
					{{ experience.gallery.featured_photo.caption }}
				</div>
			{% endif %}
		{% else %}
			{% if user in experience.explorers.all %}
				<a href="{% url 'exp_upload_photo' experience.id %}" title="Upload photo for this experience">
					<img src="{{ STATIC_URL }}img/logo.jpg" />
				</a>
			{% else %}
				<img src="{{ STATIC_URL }}img/logo.jpg" />
			{% endif %}
		{% endif %}
	</div>
	<div class="option_list">
		{% if comrade %} 
			<a href="{% url 'create_narrative' experience.id %}"><img src="{{ STATIC_URL }}img/icons/new-narrative-icon.png" title="Create a new narrative" class="option_icon" /></a>
			<a href="{% url 'experiences.views.edit' experience.id %}"><img src="{{ STATIC_URL }}img/icons/edit-icon.png" title="Edit this experience" class="option_icon" /></a>
			<a href="{% url 'experiences.views.upload_photo' experience.id %}"><img src="{{ STATIC_URL }}img/icons/image-upload-icon.png" title="Upload a photo" class="option_icon" /></a>
		{% else %}
			{% if user.is_authenticated %}
				{% if experience not in user.tracking_experiences.all %}
					<form action="{% url 'track_experience' experience.id %}" method="POST">
						{% csrf_token %}
						<input type="submit" value="Track" title="Add this experience to your tracking list" />
					</form>
				{% else %}
					<form action="{% url 'untrack_experience' experience.id %}" method="POST">
						{% csrf_token %}
						<input type="submit" value="Untrack" title="Remove this experience from your tracking list" />
					</form>
				{% endif %}
			{% endif %}
		{% endif %}
		{% if experience.gallery %}
			<a href="{% url 'pl-gallery' experience.gallery.id %}"><img src="{{ STATIC_URL }}img/icons/gallery-icon.png" class="option_icon" title="View Photos for {{ experience }}" /></a>
		{% endif %}
		{% if author %}
			<a href="{% url 'experience_invite' experience.id %}"><img src="{{ STATIC_URL }}img/icons/add-user-icon.png" class="option_icon" title="Invite a comrade to be a part of this experience" /></a>
			<a href="{% url 'experiences.views.delete' experience.id %}"><img src="{{ STATIC_URL }}img/icons/delete-icon.png" title="Delete this experience" class="option_icon" /></a>
		{% endif %}
	</div>
	<h3>Explorer{{ experience.explorers.count|pluralize }}</h3>
	<table class="thirds_table">
		<tr>
			{% for explorer in experience.explorers.all %}
				<td>
					{% include "explorers/snippets/dash.html" %}
					{% comment %}
						<div class="object_item thirds_item explorer_item dash_item">
							{% if explorer.gallery.featured_photo %}
								<img src="{{ explorer.gallery.featured_photo.get_icon_url }}" title="{{ explorer.get_full_name }}" />
							{% endif %}
							<a href="{% url 'journey' explorer.id %}"><h3>{{ explorer.get_full_name }}</h3></a>
						</div>
					{% endcomment %}
				</td>
			{% endfor %}
		</tr>
	</table>
	{% if experience.brief %}
		<div class="experience_item">
			<h3>Experience brief</h3>
			{{ experience.embedded_brief|safe|linebreaks }}
		</div>
	{% else %}
		{% if comrade %}
			<h3>Write a brief</h3>
			<form action="{% url 'experiences.views.brief' experience.id %}" method="POST">
				{% csrf_token %}
				{{ experience_brief_form.brief }}
				<input type="hidden" name="explorer_id" value="{{ experience.explorer_id }}" />
				<input type="submit" value="Submit" />
			</form>
		{% else %}
			{{ block.super }}
		{% endif %}
	{% endif %}
	{% if comrade %}
		<a href="{% url 'create_narrative' experience.id %}"><h3><img src="{{ STATIC_URL }}img/icons/new-narrative-icon.png" style="vertical-align: middle;" /> Create new narrative</h3></a>
		{% comment %}
		{# Following being phased out for a couple reasons: clutters the page, and formatting screwy when expanding with jQuery #}
		<h3 title="Click for a new narrative" onclick="toggle_div('new_narrative_form');">Add New Narrative <img src="{{ STATIC_URL }}img/icons/expand-icon.png" id="new_narrative_form_toggle_icon" /></h3>
		<div id="new_narrative_form" class="narrative_item">
			<form action="/experiences/{{ experience.id }}/narratives/create/" method="POST" class="full_width">
				{% csrf_token %}
				{{ form.narrative }}
				<label for="id_title"><h3>Title <em>(optional)</em></h3></label>
				{{ form.title }}
				<label for="id_category"><h3>Category <em>(optional)</em></h3></label>
				{{ form.category }}
				<input type="hidden" name="experience" value="{{ experience.id }}" />
				<input type="submit" value="Add Narrative" />
			</form>
		</div>
		{% endcomment %}
	{% endif %}
	<div class="object_item_list">
		{% if experience.narratives.count > 0 %}
			<h3>Narratives</h3>
			<table class="thirds_table">
				<tr>
					{% if user in experience.explorers.all %}
						{% for narrative in experience.ordered_narratives %}
							<td>
								{% include "narratives/snippets/dash.html" %}
							</td>
							{% if forloop.counter|divisibleby:'3' %}
								{% if not forloop.last %}
									</tr>
									<tr>
								{% endif %}
							{% endif %}
						{% endfor %}
					{% else %}
						{% for narrative in experience.public_narratives %}
							<td>
								{% include "narratives/snippets/dash.html" %}
							</td>
							{% if forloop.counter|divisibleby:'3' %}
								{% if not forloop.last %}
									</tr>
									<tr>
								{% endif %}
							{% endif %}
						{% endfor %}
					{% endif %}
				</tr>
			</table>
		{% else %}
			No narratives yet
		{% endif %}
	</div>
	{% get_comment_count for experience as exp_comment_count %}
	{% if exp_comment_count > 0 %}
		<h4 title="Click to expand" onclick="toggle_div('exp_comment_list');">{{ exp_comment_count }} Note{{ exp_comment_count|pluralize }} <img src="{{ STATIC_URL }}img/icons/expand-icon.png" id="exp_comment_list_toggle_icon" /></h4>
		<div class="comment_list" id="exp_comment_list">
			{% get_comment_list for experience as exp_comment_list %}
			{% for note in exp_comment_list reversed %}
				{% include "support/snippets/note.html" %}
			{% endfor %}
		</div>
	{% endif %}
	{% if user.is_authenticated %}
		{% get_comment_form for experience as comment_form %}
		<h4 onclick="toggle_div('{{ experience.id }}_note');">Leave a Note <img src="{{ STATIC_URL }}img/icons/expand-icon.png" id="{{ experience.id }}_note_toggle_icon" /></h4>
		<div id="{{ experience.id }}_note" class="comment" style="display: none;">
			{# Create context for html snippet #}
			{% with next_url_name='experience' next_url_pk=experience.id %}
			    {% include "support/snippets/note_form.html" %}
			{% endwith %}
		</div>
	{% endif %}
{% endblock content %}
