{% load comments %}
{% load narrative_extras %}

<h2>{{ narrative.title }}</h2>
{% if not narrative.is_public %}
    <strong>This is a private narrative. It can only be viewed by the explorers of the narrative's experience{% if narrative.experience.password %} and those who provide the correct password{% endif %}.</strong>
{% endif %}
<div class="option_list">
    {% url 'experience' narrative.experience.id as experience_path %}
    {% ifnotequal experience_path request.path %}
        <a href="{% url 'experiences.views.index' narrative.experience.id %}"><img src="{{ STATIC_URL }}img/icons/go-back.png" title="Back to the experience page" class="option_icon" /></a>
    {% endifnotequal %}
    {% if narrative.gallery %}
        <a href="{% url 'pl-gallery' narrative.gallery.id %}"><img src="{{ STATIC_URL }}img/icons/images.png" class="option_icon" title="View Photos for {{ narrative }}" /></a>
    {% endif %}
    {% if author %}
        <a href="{% url 'narratives.views.edit' narrative.id %}"><img src="{{ STATIC_URL }}img/icons/pencil.png" title="Edit this narrative" class="option_icon" /></a>
        <a href="/narratives/{{ narrative.id }}/upload_photo/"><img src="{{ STATIC_URL }}img/icons/camera.png" title="Upload a photo" class="option_icon" /></a>
        <a href="{% url 'narratives.views.delete' narrative.id %}"><img src="{{ STATIC_URL }}img/icons/delete.png" title="Delete this narrative" class="option_icon" /></a>
    {% endif %}
    {% if user.is_authenticated %}
        <a onclick="toggle_div('{{ narrative.id }}_note');"><img src="{{ STATIC_URL }}img/icons/tack.png" title="Tack on a note" class="option_icon" /></a>
    {% endif %}
</div>
{% get_comment_form for narrative as comment_form %}
<div id="{{ narrative.id }}_note" class="comment" style="display: none;">
    {% with next_url_name='narrative' next_url_pk=narrative.id %}
        {% include "support/snippets/note_form.html" %}
    {% endwith %}
</div>
<div class="narrative_detail">
    {% if narrative.gallery.photos %}
        <div class="images_right">
            {% for photo in narrative.gallery.photos.all %}
                <div class="narrative_photo">
                    <a href="{{ photo.get_absolute_url }}"><img src="{{ photo.get_thumbnail_url }}" title="{{ photo.title }}" /></a>
                    {% if photo.caption %}
                        <div class="photo_caption">
                            {% if photo.caption %}
                                {{ photo.caption }}
                            {% else %}
                                {{ photo.title }}
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    {% endif %}
    <p style="text-align:right;">{{ narrative.date_created|date:"F j, Y" }}</p>
    <div>
        {{ narrative.embedded_narrative|safe|linebreaksbr }}
    </div>
    <div class="clear_both"> </div>
</div>
<div class="next_previous">
    {% if privileged %}
        {% if narrative.get_previous_narrative %}
            <a href="{% url 'narratives.views.index' narrative.get_previous_narrative.id %}"><img src="{{ STATIC_URL }}img/icons/arrow-left.png" class="float_left" title="Previous narrative - {{ narrative.get_previous_narrative }}"
            /></a>
        {% endif %}
        {% if narrative.get_next_narrative %}
            <a href="{% url 'narratives.views.index' narrative.get_next_narrative.id %}"><img src="{{ STATIC_URL }}img/icons/arrow-right.png" class="float_right" title="Next narrative - {{ narrative.get_next_narrative }}" /></a>
        {% endif %}
    {% else %}
        {% if narrative.get_previous_public_narrative %}
            <a href="{% url 'narratives.views.index' narrative.get_previous_public_narrative.id %}"><img src="{{ STATIC_URL }}img/icons/arrow-left.png" class="float_left" title="Previous narrative - {{ narrative.get_previous_public_narrative }}" /></a>
        {% endif %}
        {% if narrative.get_next_public_narrative %}
            <a href="{% url 'narratives.views.index' narrative.get_next_public_narrative.id %}"><img src="{{ STATIC_URL }}img/icons/arrow-right.png" class="float_right" title="Next narrative - {{ narrative.get_next_public_narrative }}"
            /></a>
        {% endif %}
    {% endif %}
</div>
{% ifnotequal experience_path request.path %}
    <div class="experience_item">
        <p>from experience <a href="{% url 'experience' narrative.experience.id %}">{{ narrative.experience }}</p></a>
    </div>
{% endifnotequal %}
<div class="explorer_item"> 
    <p>by <a href="{% url 'journey' narrative.author.id %}">{{ narrative.author.get_full_name }}</a></p>
</div>
{% get_comment_count for narrative as narr_comment_count %}
{% if narr_comment_count > 0 %}
    <h4 title="Click to see comments" onclick="toggle_div('narr_comment_list');">{{ narr_comment_count }} note{{ narr_comment_count|pluralize }} <img src="{{ STATIC_URL }}img/icons/expand-icon.png" id="narr_comment_list_toggle_icon" /></h4>
    <div class="comment_list" id="narr_comment_list" style="display: none;">
        {% get_comment_list for narrative as narr_comment_list %}
        {% for note in narr_comment_list reversed %}
            {% include "support/snippets/note.html" %}
        {% endfor %}
    </div>
{% endif %}