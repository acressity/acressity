{% extends "explorers/base.html" %}

{% load comments %}
{% load comments_xtd %}
{% load explorers_extras %}

{% block content %}
    <div class="explorer_item">
        <div class="jumbotron">
            <h1>Explorer Profile<h1>
            <h2>{% if user == explorer %}You{% else %}{{ explorer.get_full_trailname }}{% endif %}</h2>
        </div>
    </div>
     
	{% include "explorers/snippets/dash.html" %}

	<div class="explorer_item">
		{% if not request.user == explorer and user.is_authenticated and request.user not in explorer.cheerers %}
			<form action="/explorers/{{ explorer.id }}/cheer/" method="POST">
				{% csrf_token %}
				<input type="hidden" name="explorer" value="{{ explorer.get_full_name }}" />
				<input type="submit" name="cheer" value="Cheer" title="Subscribe to {{ explorer.get_full_name }}" onclick="var a = verify('Subscribe to {{ explorer.get_full_name }}?'); return a;" />
			</form>
		{% endif %}
		{% if request.user == explorer %}
			{% if form.errors %}
				<p>Problem with saving</p>
				{% for error in form.errors %}
					{{ error }}
				{% endfor %}
			{% endif %}
			<form method="POST">
                {% csrf_token %}
                <div class="formatted_input">
                    <label>
                        <h3>First name</h3>
                    </label>
                    {{ form.first_name.errors }}
                    {{ form.first_name }}
                </div>
                <div class="formatted_input">
                    <label>
                        <h3>Last name</h3>
                    </label>
                    {{ form.last_name.errors }}
                    {{ form.last_name }}
                </div>
                <div class="formatted_input">
                    <label>
                        <h3>Trailname</h3>
                    </label>
                    {{ form.trailname.errors }}
                    {{ form.trailname }}
                    <div class="about_this">
                        <span onclick="toggle_div('about_trailname');">About this <img src="{{ STATIC_URL }}img/icons/expand-icon.png" id="about_trailname_toggle_icon" /></span>
                        <div id="about_trailname" class="toggle_div help-text">
                            {{ form.trailname.help_text|safe }}
                        </div>
                    </div>
                </div>
                <div class="formatted_input">
                    <label for="id_featured_experience">
                        <h3>Featured experience</h3>
                    </label>
                    {{ form.featured_experience.errors }}
                    {{ form.featured_experience }}
                </div>
                <div class="formatted_input">
                    <label>
                        <h3>Brief</h3>
                    </label>
                    {{ form.brief.errors }}
                    {{ form.brief}}
                    <div class="about_this">
                        <span onclick="toggle_div('about_brief');">About this <img src="{{ STATIC_URL }}img/icons/expand-icon.png" id="about_brief_toggle_icon" /></span>
                        <div id="about_brief" class="toggle_div help-text">
                            {{ form.brief.help_text }}
                        </div>
                    </div>
                </div>
                <div class="formatted_input">
                    <label>
                        <h3>Email</h3>
                    </label>
                    {{ form.email.errors }}
                    {{ form.email }}
                    <div class="about_this">
                        <span onclick="toggle_div('about_email');">About this <img src="{{ STATIC_URL }}img/icons/expand-icon.png" id="about_email_toggle_icon" /></span>
                        <div id="about_email" class="help-text toggle_div">
                            {{ form.email.help_text }}
                        </div>
                    </div>
                </div>
                <div class="formatted_input">
                    {# Having label for this doesn't make sense: no obvious first input #}
                    <h3>Be notified of new activity on your journey? {{ form.notify }}</h3>
                    {{ form.notify.errors }}
                </div>
                <div class="formatted_input">
                    {# Having label for this doesn't make sense: no obvious first input #}
                    <h3>Birthdate</h3>
                    {{ form.birthdate.errors }}
                    {{ form.birthdate }}
                </div>
				<div class="formatted_input">
					<h3>Stripe Account</h3>
					{% if not explorer.is_stripe_connected %}
                        <div>
                            <a href="{% url 'stripe_connect.authorize' %}">
                                <img src="{{ STATIC_URL }}img/stripe/blue-on-light.png" />
                            </a>
                        </div>
					{% else %}
                        <div>
                            <a href="{{ request.user.stripe_account.stripe_dashboard_url }}">
                                Stripe account dashboard
                            </a>
                        </div>
                        <div>
                            <a href="{% url 'stripe_connect.disconnect' explorer.stripe_account.pk %}">
                                Disconnect Stripe account
                            </a>
                        </div>
					{% endif %}
                    <div class="about_this">
                        <span onclick="toggle_div('about_stripe');">About this <img src="{{ STATIC_URL }}img/icons/expand-icon.png" id="about_stripe_toggle_icon" /></span>
                        <div id="about_stripe" class="toggle_div help-text">
                            Create or connect Stripe account to accept or make benefaction payments
                        </div>
                    </div>
				</div>

                <div class="formatted_input">
                    <a href="{% url 'change_password' %}">Change your password</a>
                </div>

                <div class="formatted_input align_center">
                    <input type="submit" value="Save" />
                </div>
			</form>
		{% else %}
			{% if explorer.brief %}
			    <p>
				    {{ explorer.brief|linebreaks }}
				</p>
			{% endif %}
			{% if explorer.birthdate %}
				<p>Birthday: {{ explorer.birthdate }}</p>
			{% endif %}
		{% endif %}
		<p>
			Member since {{ explorer.date_joined|date:'F j, o' }}
		</p>
	</div>
	{% if request.user == explorer %}
		<form method="POST" action="{% url 'explorer.delete' request.user.pk %}">
			{% csrf_token %}
			<div class="formatted_input align_center">
				<input type="submit" value="Delete" class="danger" />
			</div>
		</form>
	{% endif %}

    <div class="comment_item">
        {% get_comment_count for explorer as comment_count %}
        <h3>
            {{ comment_count }} Note{{ comment_count|pluralize }}
        </h3>

        {% if user.is_authenticated %}
            {% render_comment_form for explorer %}
        {% else %}
            <p>Please <a href="{% url 'login' %}">log in</a> or <a href="{% url 'register' %}">sign up</a> to leave a note<p>
        {% endif %}

        {% render_comment_list for explorer %}
    </div>
{% endblock content %}
